# ACTIVE MEMORY: Issue #11

## Link
https://github.com/huypham37/pmi-gpt/issues/11

## Context & Goal
**Goal:** Add a new specialized UI mode for generating and managing security test cases (e.g., XSS, SQL injection) with a dedicated workflow separate from the standard chat view.

### Overview

This feature introduces a **Test Case Generator Mode** with 3 interconnected views:
1. **Test Case Generator Panel** - Input prompt + grid of generated test cases
2. **Test Case Card** - Collapsed summary view of a selected test case
3. **Report View** - Expanded detailed view with full test case information

### Key Components
- InputContainer (compactMode) at top for generating tests
- Scrollable grid of test case cards (LIFO ordering)
- Expandable report view with full details
- Integration with existing ChatDisplay for conversation
- Separate navigator option (4th navigator alongside chats/sources/skills/settings)

### Sub-issues (Implementation Order)
1. #12 - Define TestCase data model and types
2. #13 - Create TestCaseCard component (collapsed view)
3. #14 - Create TestCaseReportView component (expanded view)
4. #15 - Create TestCaseGrid component for generator mode
5. #16 - Create TestCaseGeneratorPanel main container
6. #17 - Add test case generator state management (Jotai atoms)
7. #18 - Implement navigation flow between test case views
8. #19 - Integrate Test Case Generator Mode into app routing

## Plan
- [x] Setup branch and environment
- [x] Define TestCase data model (Issue #12)
- [x] Create TestCaseCard component (Issue #13)
- [x] Create TestCaseReportView component (Issue #14)
- [x] Create TestCaseGrid component (Issue #15)
- [x] Create TestCaseGeneratorPanel main container (Issue #16)
- [x] Add test case generator state management with Jotai atoms (Issue #17)
- [x] Implement navigation flow between views (Issue #18)
- [x] Integrate into app routing system (Issue #19)

## Progress Log
### [2026-02-16] Initialization
- Spawned from issue #11
- Branch created: feature/11-test-case-generator-mode
- Verified understanding of UI design and component architecture
- Key insights:
  - Use existing InputContainer component in compactMode for test generation input
  - Reuse ChatDisplay for full conversation view
  - Test cases use session profile: 'testcase'
  - Follow existing patterns: routes, atoms (atomFamily), navigator panels

### [2026-02-16] Issue #12 Complete - TestCase data model
- Added to `types.ts`: TestCaseCategory, TestCaseSeverity, TestCaseStatus, TestCaseOutcome, TestCaseTarget, TestCaseAttackVector, TestCaseCVSS, TestCase, TestCaseMeta, TestCaseViewMode, TestCasesNavigationState
- Added helper functions: extractTestCaseMeta(), getTestCaseStatusLabel(), getTestCaseCategoryLabel()
- Updated NavigationState union, added isTestCasesNavigation() type guard
- Updated getNavigationStateKey() and parseNavigationStateKey() for testcases persistence
- Updated `route-parser.ts`: Added 'testcases' to NavigatorType, COMPOUND_ROUTE_PREFIXES, parseCompoundRoute, buildRouteFromNavigationState, all conversion functions
- Routes: testcases, testcases/session/{id}, testcases/session/{id}/case/{caseId}
- 0 new TS errors introduced

### [2026-02-16] All Sub-issues Complete (#12-#19)
- **Issue #17**: Created `atoms/testcases.ts` - testCaseAtomFamily, testCaseMetaMapAtom, testCaseIdsForSessionAtomFamily, CRUD action atoms (add, update, remove, initialize, ensureLoaded with promise dedup)
- **Issue #13**: Created `components/testcases/TestCaseCard.tsx` - Memoized card with severity color coding, status icons, category badges, hover expand
- **Issue #15**: Created `components/testcases/TestCaseGrid.tsx` - 2-column grid using per-session atom for LIFO ordering
- **Issue #14**: Created `components/testcases/TestCaseReportView.tsx` - Full report with sections for status, target, description, attack vector, expected/actual results, CVSS, reproduce steps
- **Issue #16**: Created `pages/TestCaseGeneratorPage.tsx` - Main container with PanelHeader, InputContainer (compactMode), view mode switching (grid/report)
- **Issue #18**: Updated NavigationContext.tsx with isTestCasesNavigation, applyNavigationState handler, routes.view.testcases() builder
- **Issue #19**: Integrated into AppShell (LeftSidebar button, TestCasesNavigatorPanel, listTitle, unifiedSidebarItems), MainContentPanel rendering

### Files Created
- `apps/electron/src/shared/types.ts` (modified - TestCase types + navigation)
- `apps/electron/src/shared/routes.ts` (modified - testcases route builder)
- `apps/electron/src/shared/route-parser.ts` (modified - testcases parsing)
- `apps/electron/src/renderer/atoms/testcases.ts` (new)
- `apps/electron/src/renderer/atoms/sessions.ts` (modified - added profile to SessionMeta)
- `apps/electron/src/renderer/components/testcases/TestCaseCard.tsx` (new)
- `apps/electron/src/renderer/components/testcases/TestCaseGrid.tsx` (new)
- `apps/electron/src/renderer/components/testcases/TestCaseReportView.tsx` (new)
- `apps/electron/src/renderer/components/testcases/TestCasesNavigatorPanel.tsx` (new)
- `apps/electron/src/renderer/pages/TestCaseGeneratorPage.tsx` (new)
- `apps/electron/src/renderer/contexts/NavigationContext.tsx` (modified)
- `apps/electron/src/renderer/components/app-shell/AppShell.tsx` (modified)
- `apps/electron/src/renderer/components/app-shell/MainContentPanel.tsx` (modified)

### [2026-02-16] Back Button Fix
- Root cause: custom header div lacked `relative z-panel` classes that PanelHeader uses to sit above titlebar drag region (z-index 40 vs 50)
- Fix: Added `relative z-panel` to the report view header container
- Click events now reach the handler correctly

### [2026-02-16] Send Flow Wiring
- Added `profile?: AgentProfile` to `CreateSessionOptions` in `shared/types.ts`
- Wired `main/sessions.ts` createSession to set profile on ManagedSession during construction and call `setSessionProfile()` for persistence + ACP mode
- Wired `TestCaseGeneratorPage.handleSubmit` with `useAppShellContext()` to use `onCreateSession({ profile: 'testcase' })` + `onSendMessage(sessionId, message)`

### [2026-02-16] Model Resolution Fix
- Bug: AppSettings model change was ignored — sessions always fell back to hardcoded `DEFAULT_MODEL` (`gpt-oss-20b`)
- Root cause: Model resolution chain in `createSession` was `options?.model || storedSession.model || defaultModel` — missing global config fallback
- Fix: Added `getModel()` as 2nd priority (after `options.model`, before `storedSession.model`), making AppSettings the top user-facing priority
- New chain: `options?.model || globalConfigModel || storedSession.model || defaultModel || DEFAULT_MODEL`

### [2026-02-16] Schema Update
- Removed: `TestCaseSeverity`, `TestCaseStatus`, `TestCaseOutcome`, `TestCaseCVSS`, `getTestCaseStatusLabel()`
- Added: `CAPECReference { id, name, url? }`, `OWASPWSTGReference { id, name, url? }`
- TestCase now has `capecReference?: CAPECReference[]`, `owaspWstg?: OWASPWSTGReference[]`
- TestCaseMeta has `capecIds?: string[]`, `owaspWstgIds?: string[]`
- Updated TestCaseCard, TestCaseReportView, mockTestCases to use new schema

### [2026-02-16] Stub Send Flow for Testing
- Replaced real `onCreateSession` + `onSendMessage` calls with a local stub in `handleSubmit`
- Stub flow: User types prompt → clicks Send → "Generating test cases..." spinner appears → 1.5s simulated delay → 2-4 test cases generated with random categories (xss, sql-injection, csrf, ssrf, auth-bypass, idor) → cards appear one by one (300ms stagger) in the grid
- No backend calls made — entire flow is simulated locally via `addTestCaseAtom`
- Removed mock data auto-seeding on mount; grid starts empty
- `generateStubTestCases(sessionId, prompt)` creates test cases with CAPEC/OWASP references based on category
- Each submit appends more cards (LIFO ordering, newest first)
- Stub uses incrementing counter for unique IDs across multiple submits

### [2026-02-16] Test Case Persistence
- Implemented single flat global JSON file storage: `~/.craft-agent/testcases.json`
- Created `packages/shared/src/testcases/storage.ts` - listTestCases(), getTestCase(id), saveTestCase(tc), saveTestCases(tcs), deleteTestCase(id), deleteAllTestCases()
- Added 6 IPC channels to `shared/types.ts`: TESTCASES_LIST, GET, SAVE, SAVE_BATCH, DELETE, DELETE_ALL + ElectronAPI methods
- Added preload API methods in `preload/index.ts` - all map to ipcRenderer.invoke()
- Added IPC handlers in `main/ipc.ts` (6 handlers with dynamic imports from '@craft-agent/shared/testcases/storage')
- Wired `atoms/testcases.ts` to persist:
  - addTestCaseAtom → calls window.electronAPI.saveTestCase(tc)
  - updateTestCaseAtom → calls window.electronAPI.saveTestCase(updated)
  - removeTestCaseAtom → calls window.electronAPI.deleteTestCase(id)
  - loadAllTestCasesAtom → calls window.electronAPI.listTestCases() on app startup
  - ensureTestCaseLoadedAtom → calls window.electronAPI.getTestCase(id)
- Bug fix: TestCaseGrid was filtering by session ID (testCaseIdsForSessionAtomFamily) — loaded test cases with different session IDs were invisible after refresh. Changed TestCaseGrid to accept `testCaseIds` prop directly. TestCaseGeneratorPage passes `allTestCaseIdsAtom` value (global flat list).
- Test cases now persist across app restarts

### Current Step
Persistence complete and tested. Test cases survive refresh. Ready to implement AI response parser.

### Next Immediate
- **AI Response Parser**: Create markdown parser for AI-generated test case responses
  - Parse markdown sections: Name, Description, OWASP Reference, CAPEC Reference, Attack Vector, Steps to Reproduce, Expected Behavior
  - **Guidance section**: Parse markdown table with columns: Step | Expected Result | Example
  - Use regex to extract fields and construct TestCase objects
  - Wire parser into session event listener to convert AI responses → test case cards
- Replace stub in TestCaseGeneratorPage with real onSendMessage flow once parser is ready
- Create PR
