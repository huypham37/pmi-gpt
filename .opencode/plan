# MVP Execution Plan

## Principle
- ACP (Agent Client Protocol) is the only agent interface
- Profiles = {mode, model} pointers; server owns tools/prompts/behavior
- No client-side multi-turn, no tools toggle
- Subprocess stdio transport (JSON-RPC over stdin/stdout)
- User picks profile, types message, done

## Phase 1: ACP Client Integration [HIGH PRIORITY]
1. Move `opencode-client/acp-client-ts/` into monorepo as `packages/acp-client/`
   - Update package.json: name=@craft-agent/acp-client, add to workspace
2. Wire ACP client into Electron Main (`apps/electron/src/main/sessions.ts`)
   - Replace CraftAgent with ACPClient + ACPSession
   - On app start: `acpClient.start()` (spawns OpenCode subprocess)
   - On session create: `acpClient.newSession()`
   - On send message: `acpSession.prompt(text)` → stream SessionUpdate events
   - Map SessionUpdate types to existing SessionEvent IPC types:
     - text → text_delta/text_complete
     - toolCall → tool_start/tool_result
     - thinking → (optional, render as text)
     - permissionRequest → permission_request
   - On abort: `acpSession.cancel()`
   - On app quit: `acpClient.stop()`
   - Profile switching: `acpSession.setMode(profile.modeId)`
   - Model switching: `acpSession.setModel(profile.modelId)`
3. Delete `packages/shared/src/agent/providers/` (factory, opencode-provider, types)
4. Remove CraftAgent usage from hot path (keep file, mark deprecated)
5. Remove source/skills plumbing from sessions.ts (setAllSources, buildServersFromSources)

## Phase 2: Strip UI [MEDIUM PRIORITY]
1. Bypass onboarding in App.tsx (init appState='ready', remove OnboardingWizard)
2. Strip sidebar in AppShell.tsx (keep: Chats, Settings; remove: Sources, Skills, Labels, Statuses, Views)
3. Remove unreachable pages (SourceInfoPage, SkillInfoPage, playground)

## Phase 3: Profile Selection [MEDIUM PRIORITY]
1. Add `profile` field to session metadata (persisted)
2. Profile picker UI in chat header (dropdown: Chat / Agent / Testcase)
3. On profile change → `acpSession.setMode(newModeId)` + `acpSession.setModel(newModelId)`
4. Display available modes/models from ACP session.modes / session.models

## Phase 4: Cleanup [LOW PRIORITY]
1. Delete CraftAgent (packages/shared/src/agent/craft-agent.ts)
2. Delete provider abstraction remnants
3. Delete playground directory
4. Remove unused Claude SDK deps from package.json
5. Optional: strip Sentry, auto-update, deep links, thumbnails

## Event Mapping (ACP SessionUpdate → IPC SessionEvent)
| ACP SessionUpdate.type | IPC SessionEvent type     |
|------------------------|---------------------------|
| text                   | text_delta / text_complete |
| thinking               | text_delta (prefixed)      |
| toolCall               | tool_start / tool_result   |
| plan                   | (optional, render inline)  |
| permissionRequest      | permission_request         |
| configUpdate           | (update local state)       |

## Verification (after each phase)
- bun run typecheck:all
- bun test
- bun run electron:dev → app launches, can chat, attachments work

## Files Touched
- NEW: packages/acp-client/ (moved from opencode-client/acp-client-ts/)
- EDIT: apps/electron/src/main/sessions.ts (replace CraftAgent with ACPClient)
- EDIT: apps/electron/src/main/index.ts (start/stop ACP subprocess)
- EDIT: apps/electron/src/renderer/App.tsx (bypass onboarding)
- EDIT: apps/electron/src/renderer/components/app-shell/AppShell.tsx (strip sidebar)
- DELETE: packages/shared/src/agent/providers/
- DELETE: apps/electron/src/renderer/playground/
