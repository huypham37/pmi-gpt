# ACTIVE MEMORY: Issue #23
## Link
https://github.com/huypham37/pmi-gpt/issues/23

## Context & Goal
Add a Project Context layer to the Test Case Generator. Currently generation only uses the user's attack vector + OWASP WSTG entries. There is no knowledge about the specific app being tested, causing generic/hallucinated test cases.

The context layer sits between user input and the LLM:
```
User input (attack vector)
       ↓
[Context Layer]
  ├── Project description (free text: tech stack, arch, auth, endpoints)
  ├── Documents (user-uploaded PDF/DOCX, content extracted + embedded)
  └── WSTG entries (RAG-retrieved, already exists)
       ↓
Augmented prompt → LLM → TestCase[]
```

## Key Decisions
- Documents stored as copies in workspace directory (`{workspace.rootPath}/context/docs/`), NOT references to original paths
- Manifest JSON at `{workspace.rootPath}/context/manifest.json` tracks document metadata
- Single persistent workspace (no per-workspace complexity)
- User can add documents + write project description
- Context is silently injected into every generation — graceful fallback if empty
- File types Phase 1: PDF and DOCX (text extraction via MarkItDown)
- UI: Project Context lives in the **navigator panel** (top section), NOT in main content or right panel
- Navigator split: top = collapsible Project Context section, bottom = Test Cases session list

## Files Changed
| File | What changed |
|------|-------------|
| `apps/electron/src/shared/types.ts` | Added `ProjectContext`, `ContextDocument` types; 4 IPC channels; 4 `ElectronAPI` methods |
| `apps/electron/src/main/ipc.ts` | 4 IPC handlers (`CONTEXT_GET/SAVE_DESCRIPTION/ADD_DOCUMENT/REMOVE_DOCUMENT`); `TESTCASES_GENERATE` now loads + injects context |
| `apps/electron/src/main/wstg-prompt.ts` | `buildAugmentedPrompt()` accepts optional `projectContext` param, injects "### Project Context" section |
| `apps/electron/src/preload/index.ts` | Bridged 4 context IPC calls |
| `apps/electron/src/renderer/components/testcases/TestCasesNavigatorPanel.tsx` | Rewritten: split into top `ProjectContextSection` + bottom Test Cases list |
| `apps/electron/src/renderer/components/testcases/ProjectContextPanel.tsx` | Created (standalone full-page panel, currently unused but available) |
| `apps/electron/src/renderer/pages/TestCaseGeneratorPage.tsx` | Cleaned up — no context UI here, only grid/report/chat |
| `apps/electron/src/renderer/components/app-shell/MainContentPanel.tsx` | Cleaned up — no context branch, simple testcases passthrough |

## Plan
- [x] Design `ProjectContext` type + storage schema
- [x] IPC handlers: `CONTEXT_GET`, `CONTEXT_SAVE_DESCRIPTION`, `CONTEXT_ADD_DOCUMENT`, `CONTEXT_REMOVE_DOCUMENT`
- [x] PDF + DOCX text extraction (main process, MarkItDown)
- [x] Update `buildAugmentedPrompt()` to accept + inject project context
- [x] Update `TESTCASES_GENERATE` IPC handler to load + pass context
- [x] UI: Navigator panel split — top = inline Project Context, bottom = Test Cases
- [x] Tests: prompt injection (unit + full E2E flow with synthetic context)

## Progress Log
### 2026-02-18 Initialization
- Spawned from issue #23.
- Branch: `feature/23-project-context-layer`

### 2026-02-18 Implementation Complete (Phase 1)
Current Step: All core features implemented, no new TS errors. Ready for testing.

Completed:
- Backend: types, IPC handlers, preload bridge, MarkItDown extraction, prompt injection
- Frontend: Navigator panel split into collapsible Project Context section (description textarea + document list) and Test Cases session list
- Integration: `TESTCASES_GENERATE` loads context from disk and passes to `buildAugmentedPrompt()`

Design iteration:
- Initially placed Context button in main content header → moved to navigator pinned row → final: inline editable section in navigator top half

Next immediate: All plan items complete.

### 2026-02-18 Tests + Attack Vector Enforcement
- Added 11 unit tests for `buildAugmentedPrompt` with project context (description, documents, truncation, empty fallback)
- Added 3 full-flow integration tests (end-to-end with synthetic context, empty fallback, multiple docs)
- Updated `test-full-flow.ts` to inject synthetic project context (Healthcare SaaS) into the E2E pipeline
- Updated prompt to enforce LLM analyzing + restating user's attack vector in each test case's `**Attack Vector:**` field
- Added attack vector display to `test-full-flow.ts` Step 5 + Step 6 output
- Verified: 14/14 test cases had attack vector field populated with specific techniques derived from user query
- All 35 unit tests pass, all 6 E2E steps pass
