# ACTIVE MEMORY: Issue #1

## Link
https://github.com/huypham37/pmi-gpt/issues/1

## Context & Goal
Create a centralized configuration file for the new PMI-Agent (OpenCode client wrapper) that serves as the single source of truth for all agent settings.

### Requirements
- [ ] Create pmi-agent.config.json or similar config file
- [ ] Define schema for configuration options:
  - Provider settings (model, endpoint, API keys)
  - Default workspace settings
  - Session defaults (thinking level, permission mode)
  - MCP server configurations
- [ ] Implement config loader with validation (Zod schema)
- [ ] Support environment variable overrides
- [ ] Add config file watcher for hot-reload

### Proposed Location
~/.pmi-agent/config.json

### Proposed Schema
```json
{
  "provider": {
    "type": "lmstudio",
    "baseUrl": "http://localhost:1234/v1",
    "model": "default"
  },
  "workspace": {
    "defaultPath": "~/.pmi-agent/workspaces/default"
  },
  "session": {
    "thinkingLevel": "think",
    "permissionMode": "default"
  },
  "mcp": {
    "servers": []
  }
}
```

### Related Files
- packages/shared/src/config/storage.ts
- packages/shared/src/agent/providers/opencode-provider.ts

## Plan
- [ ] Setup branch and environment
- [ ] Analyze existing config structure in packages/shared/src/config/
- [ ] Design PMI-Agent specific config schema (extending/adapting Craft Agent config)
- [ ] Implement config loader with Zod validation
- [ ] Add environment variable override support
- [ ] Implement file watcher for hot-reload
- [ ] Test configuration loading and validation
- [ ] Update documentation

## Progress Log
### [2026-02-10] Initialization
- Spawned from issue #1
- Memory file created at .opencode/.memory/issues/1.md
- Branch: feature/1-config-single-source

### [2026-02-10] Config Analysis Complete
- Explored existing Craft Agent config system
- Identified TWO StoredConfig definitions:
  - Core (6 fields): Minimal type
  - Shared (14 fields): Extended with UI fields
- Current config location: `~/.craft-agent/config.json`

**Decision: PMI-Agent StoredConfig (11 fields)**

Core (5 fields):
- `model` - Model selection
- `mode` - Permission mode (safe/ask/allow-all) - NEW FIELD
- `workspaces` - Array of workspaces
- `activeWorkspaceId` - Current workspace
- `activeSessionId` - Current session

UI (6 fields):
- `notificationsEnabled` - Desktop notifications
- `colorTheme` - Theme ID
- `dismissedUpdateVersion` - Auto-update
- `autoCapitalisation` - Input capitalization
- `sendMessageKey` - 'enter' | 'cmd-enter'
- `spellCheck` - Spell check toggle

Removed from Craft Agent config:
- ❌ `provider` - Not needed (always OpenCode)
- ❌ `authType` - OpenCode handles auth
- ❌ `anthropicBaseUrl` - OpenCode handles endpoint
- ❌ `customModel` - Not needed

**Config Access Pattern: Option 1 - Keep Electron UI**
- UI → IPC → storage.ts functions → config.json
- Config watcher for hot-reload
- Same pattern as Craft Agent

**Next Steps:**
1. ~~Update Core StoredConfig type (add `mode`, remove `provider`)~~ DONE
2. ~~Create config schema with Zod validation~~ DONE
3. ~~Add IPC handlers for `mode` field~~ DONE
4. ~~Fix renderer type errors (App.tsx, AppSettingsPage.tsx, useOnboarding.ts)~~ DONE
5. Add UI for `mode` selector in Settings (optional follow-up)
6. Test config loading and validation

### [2026-02-10] Renderer Fixes Complete
- **App.tsx**: Made `refreshCustomModel` a no-op (OpenCode handles model config). Removed `getApiSetup()` call from init effect. `customModel` state kept but always `null` — full removal is a follow-up.
- **AppSettingsPage.tsx**: Removed entire API Connection section (auth/credentials managed by OpenCode). Removed unused imports (`X`, `FullscreenOverlayBase`, `useSetAtom`, `fullscreenOverlayOpenAtom`, `AuthType`, `useOnboarding`, `OnboardingWizard`, `useAppShellContext`). Page now only shows Notifications + About.
- **useOnboarding.ts**: Removed `testApiConnection` call — OpenCode handles connection validation. Credential submission now saves directly without client-side connection test.

**Typecheck Status:** 0 new errors. 2 pre-existing errors remain (not from our changes):
- `AppearanceSettingsPage.tsx:258` — Element vs string type
- `session-scoped-tools.ts:1445` — `isGoogleOAuthConfigured` not found

**Current Step:** All renderer type errors fixed. Ready to commit.
**Next Immediate:** Commit all changes and create PR for Issue #1.
