# ACTIVE MEMORY: Issue #24
## Link
https://github.com/huypham37/pmi-gpt/issues/24

## Context & Goal
Replace MarkItDown with Docling (IBM, Python) for document text extraction in the Project Context layer. Docling provides advanced PDF understanding (layout, tables, OCR, reading order) vs MarkItDown's basic extraction.

Integration approach: **spawn Docling CLI as subprocess** from Electron main process.

```
User uploads PDF/DOCX
       ↓
[CONTEXT_ADD_DOCUMENT IPC handler]
  ├── Copy file to workspace context/docs/
  ├── Spawn `docling <filepath> --to md` subprocess
  ├── Capture markdown output
  └── Store as extractedText in ContextDocument
       ↓
manifest.json updated
```

## Key Decisions
- Subprocess via `child_process.spawn` (not HTTP server, not MCP)
- Docling CLI outputs markdown to stdout or temp file
- No fallback — if Docling is not installed, notify user to install it (`pip install docling`)
- Expand supported file types: PPTX, XLSX, HTML, images (Docling supports all)
- Python 3.10+ required on user machine

## Files to Change
| File | What to change |
|------|---------------|
| `apps/electron/src/main/docling-extract.ts` | New: utility to spawn Docling CLI and capture output |
| `apps/electron/src/main/ipc.ts` | Update `CONTEXT_ADD_DOCUMENT` handler to use Docling instead of MarkItDown |
| `apps/electron/src/renderer/components/testcases/TestCasesNavigatorPanel.tsx` | Update file type filter in upload dialog |
| `apps/electron/src/shared/types.ts` | Expand `ContextDocument.type` to include new formats |

## Plan
- [x] Create `docling-extract.ts` utility (spawn CLI, parse output)
- [x] Update `CONTEXT_ADD_DOCUMENT` IPC handler to use Docling
- [x] Detect if Docling is installed; if not, surface error notification to user with install instructions
- [x] Expand supported file types in UI and types
- [x] Tests: Docling subprocess extraction, fallback behavior
- [ ] Explore main chat file attachment flow — check if it differs from testcase/project-context attachment and whether it also needs Docling
- [ ] Document Python/Docling install requirement

## Progress Log
### 2026-02-18 Initialization
- Spawned from issue #24.
- Research: Docling is Python-only (53k⭐, IBM), supports PDF/DOCX/PPTX/XLSX/HTML/images with advanced layout detection, OCR, table structure.
- Decision: subprocess approach chosen over Docling Serve (HTTP) or Docling MCP.

### 2026-02-18 Core Implementation Complete
- **`apps/electron/src/main/lib/docling-extract.ts`** (new): spawns `docling --to md --output <tmpdir> <file>`, reads output `.md`, cleans up tmp dir. Throws user-friendly error on `ENOENT` ("Run: pip install docling").
- **`apps/electron/src/main/ipc.ts`**: `CONTEXT_ADD_DOCUMENT` handler now validates extension against `DOCLING_EXTS` and calls `extractWithDocling`. Old MarkItDown call at line 699 is for a separate unrelated flow (main chat attachments) — not changed.
- **`apps/electron/src/shared/types.ts`**: `ContextDocument.type` expanded to `'pdf' | 'docx' | 'pptx' | 'xlsx' | 'html' | 'image'`.
- **`apps/electron/src/renderer/components/testcases/ProjectContextPanel.tsx`**: `SUPPORTED_EXTS` updated to match Docling's full list; UI hint text updated.
- **`apps/electron/src/main/__tests__/docling-extract.test.ts`** (new): unit tests for `DOCLING_EXTS`, `IMAGE_EXTS`, `getOutputMdPath`.

Next: Explore main chat attachment flow (line 699 in ipc.ts still uses MarkItDown) to decide if Docling should replace it there too.
