# ACTIVE MEMORY: Issue #26
## Link
https://github.com/huypham37/pmi-gpt/issues/26

## Parent
Sub-issue of #24 (replace MarkItDown with Docling)

## Context & Goal
The main chat `STORE_ATTACHMENT` IPC handler (`ipc.ts:695`) uses `markitdown-js` (pure JS) to convert Office files (docx, xlsx, pptx) to markdown before attaching to a Claude message. Issue #24 migrated the **project context** layer to Docling. This issue tracks whether the **main chat** flow should follow.

## Key Facts (from exploration in #24)
- Main chat PDF â†’ raw base64 sent to Claude API (Claude reads PDFs natively, no extraction needed)
- Main chat Office â†’ `MarkItDown.convert()` â†’ `.md` string â†’ sent as text attachment
- Classification lives in `packages/shared/src/utils/files.ts` (`getFileType`, `OFFICE_EXTENSIONS`)
- `extractWithDocling` utility already exists in `apps/electron/src/main/lib/docling-extract.ts`

## Trade-offs
| | MarkItDown (current) | Docling (proposed) |
|---|---|---|
| Dependency | JS only, bundled | Python 3.10+ + pip install |
| Quality | Basic | Superior (tables, layout, OCR) |
| Speed | Fast | Slower (subprocess spawn) |
| User burden | None | Must install Python + Docling |

## Persistence Strategy
When Docling converts an Office file in the main chat flow, the resulting `.md` file **must be persisted to disk** â€” not held in memory or discarded.

Correct path (mirrors existing session attachment storage pattern):
```
~/.craft-agent/workspaces/{workspaceId}/sessions/{sessionId}/attachments/{uuid}_{filename}.md
```
This follows the same pattern as the existing `markdownPath` field on `StoredAttachment` â€” the current MarkItDown flow already writes a `.md` file and stores its path. Docling should do the same: write the `.md` output to the attachments dir and set `markdownPath` on the returned `StoredAttachment`.

## Files to Change (if proceeding)
| File | Change |
|------|--------|
| `apps/electron/src/main/ipc.ts` | Replace MarkItDown block (~line 695) with `extractWithDocling(storedPath)`, write result to `{attachmentsDir}/{uuid}_{safeName}.md`, set `markdownPath` |

## Plan
- [ ] Decide: is the quality gain worth the Python dependency for chat attachments?
- [ ] If yes: replace MarkItDown call with `extractWithDocling` in `STORE_ATTACHMENT` handler
- [ ] Update error messaging for ENOENT (Docling not installed)
- [ ] Test with docx/xlsx/pptx

## Priority
ðŸ”µ Low

## Progress Log
### 2026-02-18 Initialization
- Created as sub-issue of #24 after exploring main chat attachment flow.
- Exploration confirmed MarkItDown is used only for `type === 'office'` in `STORE_ATTACHMENT`.
- PDFs bypass extraction entirely (Claude API native support).
- No work started. Blocked on priority decision.
