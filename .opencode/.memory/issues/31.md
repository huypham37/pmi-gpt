# ACTIVE MEMORY: Issue #31
## Link
https://github.com/huypham37/pmi-gpt/issues/31

## Context & Goal
**Priority: High**

When a user uploads a markdown file in the test cases (project context), there is no detection to determine whether the file needs to go through Docling. Plain `.md` files can be read directly; other formats (PDF, DOCX, images, etc.) must go through Docling. Currently the flow treats all uploads the same way.

## Plan
- [x] Setup branch and environment
- [x] Review `addProjectContextDocument` IPC handler in main process to understand current ingestion flow
- [x] Review `apps/electron/src/main/lib/docling-extract.ts` — `DOCLING_EXTS` already defines which extensions need Docling
- [x] Add detection logic: if file extension is `.md` or `.txt`, skip Docling and read directly; otherwise route through `extractWithDocling()`
- [x] Update `ProjectContextPanel.tsx` to accept `.md` and `.txt` files in `SUPPORTED_EXTS`
- [x] Update `TestCasesNavigatorPanel.tsx` similarly
- [x] Fix delete leak: `CONTEXT_REMOVE_DOCUMENT` used `!f.endsWith('.md')` which would orphan uploaded `.md` originals — fixed to use `f.startsWith(\`${documentId}_\`)`
- [x] Update `ContextDocument.type` union in `shared/types.ts` to include `'md' | 'txt'`
- [ ] Test with a plain `.md` upload (should bypass Docling) and a `.pdf` upload (should still go through Docling)

## Key Files
- `apps/electron/src/main/lib/docling-extract.ts` — `DOCLING_EXTS`, `extractWithDocling()` — detection logic goes here
- `apps/electron/src/renderer/components/testcases/ProjectContextPanel.tsx` — file upload UI (add `.md` to accepted extensions)
- `apps/electron/src/renderer/components/testcases/TestCasesNavigatorPanel.tsx` — secondary upload UI
- Main IPC handler for `addProjectContextDocument` (locate in `apps/electron/src/main/ipc.ts` or similar) — where routing decision is made

## Technical Notes
- `DOCLING_EXTS` in `docling-extract.ts` lists formats that require Docling (`pdf`, `docx`, `pptx`, `xlsx`, `html`, images)
- `.md` files are plain text — no Docling needed, just `fs.readFile`
- Detection logic: `if (DOCLING_EXTS.includes(ext)) { extractWithDocling(path) } else { fs.readFile(path) }`

## Progress Log
### 2026-02-18 Initialization
- Spawned from issue #31.
- Branch: `feature/31-markdown-docling-detection`

### 2026-02-18 Implementation Complete
- Added `PLAIN_TEXT_EXTS = ['md', 'txt']` and `ALL_CONTEXT_EXTS` to `docling-extract.ts`
- Extended `ContextDocument.type` union in `shared/types.ts` to include `'md' | 'txt'`
- Updated `CONTEXT_ADD_DOCUMENT` IPC handler: validates against `ALL_CONTEXT_EXTS`; branches on `PLAIN_TEXT_EXTS` to read directly vs. call `extractWithDocling()`
- Fixed orphan-file leak in `CONTEXT_REMOVE_DOCUMENT`: changed match condition from `!f.endsWith('.md')` to `f.startsWith(\`${documentId}_\`)`
- Updated `ProjectContextPanel.tsx`: added `md`/`txt` to `SUPPORTED_EXTS`, updated empty-state copy
- Updated `TestCasesNavigatorPanel.tsx`: broadened filter to include all supported exts, updated button copy
- All modified files pass TypeScript type-check (pre-existing errors in other files remain unchanged)