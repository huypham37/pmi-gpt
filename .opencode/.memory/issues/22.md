# ACTIVE MEMORY: Issue #22
## Link
https://github.com/huypham37/pmi-gpt/issues/22
## Description
**Goal:** Implement RAG-based test case generation — use LMStudio to select relevant OWASP WSTG entries for a given attack vector, augment the prompt, then send to OpenCode via ACP.

**Related:** Extends #11 (Test Case Generator Mode UI)

## Current Step
Chat button end-to-end wiring complete. All tests pass. Ready to commit.

## Next Immediate
Commit all work and close issue.

## Plan
1. ✅ Add `@lmstudio/sdk` dependency to `apps/electron` (v1.5.0)
2. ✅ Create `main/wstg-data.ts` — 108 WSTG entries across 12 categories (thin: id, name, brief description, url)
3. ✅ Create `main/lmstudio.ts` — LMStudio client wrapper (selectRelevantWSTGEntries + buildAugmentedPrompt)
4. ✅ Add `TESTCASES_GENERATE` IPC handler in `main/ipc.ts`
5. ✅ Update `preload/index.ts` — expose `generateTestCases`
6. ✅ Update `TestCaseGeneratorPage.handleSubmit` — replaced stub with real IPC call
7. ✅ Moved `testcase-parser.ts` to `shared/` — renderer re-exports from shared
8. ✅ Added `generateTestCases` to `ElectronAPI` interface in `shared/types.ts`
9. ✅ Build-time JSON bundle — `scripts/build-wstg-json.ts` → `wstg-full-content.json` (108 entries, 826KB), imported in `lmstudio.ts`, `buildAugmentedPrompt` uses full markdown for primary entry
10. ✅ Enhanced augmented prompt — strict output format instructions enforce **Name:** fields, no headings, tables immediately after labels
11. ✅ Full E2E test passed — 14 test cases generated from "SQL injection in login form"

## E2E Test Results (2026-02-17)
- Attack vector: "SQL injection in login form"
- LMStudio: Qwen/Qwen3-4B-MLX-4bit → WSTG-INPV-05 (primary) + WSTG-ATHN-01, WSTG-INPV-06 (secondary)
- Augmented prompt: 36,129 chars
- OpenCode response: 15,368 chars in 86.3s (128 chunks)
- Parsed: 14 structured TestCase objects with names, targets, descriptions, guidance tables, references
- All 6 pipeline steps passed

## Progress Log
- Installed @lmstudio/sdk@1.5.0
- Created main/wstg-data.ts with WSTGEntry type (entries placeholder)
- Created main/lmstudio.ts with selectRelevantWSTGEntries() and buildAugmentedPrompt()
- Added TESTCASES_GENERATE IPC channel + handler (RAG → ACP → parse → persist)
- Exposed generateTestCases in preload
- Replaced stub generation in TestCaseGeneratorPage with real IPC call
- Moved testcase-parser.ts from renderer/utils to shared/ (renderer re-exports)
- Created scripts/build-wstg-json.ts — reads 108 .md files from wstg-tests/, outputs wstg-full-content.json (826KB)
- Updated lmstudio.ts: imports JSON, buildAugmentedPrompt uses full markdown for primary entry
- Added build:wstg script to package.json (runs before build:main)
- Added wstg-full-content.json to .gitignore (generated artifact)
- ✅ Verified build-time JSON bundle complete (108 entries, 826KB, 21 tests pass)
- ✅ Enhanced LMStudio prompt: 1 primary + 2 secondary WSTG entries
- ✅ Updated WSTGSelection interface, parseSelectedEntries, buildAugmentedPrompt
- ✅ Updated selectRelevantWSTGEntries + IPC handler
- ✅ Tests updated and passing (24 tests, 382 assertions)
- ✅ Strengthened augmented prompt with strict output format — enforces **Name:** fields, no headings, tables immediately after labels
- ✅ Full E2E test passed: 14 test cases generated, all structured correctly
- ✅ attackVector parsed from LLM output via extractField; added to TestCase + StoredTestCase interfaces
- ✅ Chat button wired end-to-end: TestCaseReportView → TestCaseGeneratorPage → MainContentPanel → routes.action.newChat({input, send:true})
- ✅ formatTestCaseChatInput util created (renderer/lib/format-testcase-chat-input.ts)
- ✅ 28 unit tests pass (12 format util + 16 parser tests including attackVector assertions)
