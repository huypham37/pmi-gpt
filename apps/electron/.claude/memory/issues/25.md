# ACTIVE MEMORY: Issue #25

## Link
https://github.com/huypham37/pmi-gpt/issues/25

## Description
**bug: auto-load LMStudio model when none is active**

When a user triggers test case generation, the RAG step that selects relevant WSTG entries fails silently if no model is currently loaded in LMStudio. Generation completes with 0 test cases and no visible error to user.

**Expected:** Auto-load a default/configured model if none is active, OR surface a clear UI error.

## Progress Log

### [2026-02-19] Session Checkpoint

**Changes:**

- **`packages/shared/src/config/models.ts`**
  - Replaced `lmstudio/qwen/qwen3-4b-thinking-2507` with `lmstudio/qwen3-4b-mlx` (`contextWindow: 50000`)
  - Updated `DEFAULT_MODEL` to `lmstudio/qwen3-4b-mlx`

- **`apps/electron/src/main/lmstudio.ts`**
  - Added `isNoModelError()`: detects `generic.noModelMatchingQuery` / `generic.specificModelUnloaded` error codes
  - Added `getOrLoadModel()`: tries `client.llm.model()` first; on no-model error, auto-loads via `client.llm.load(path, { config: { context_length } })`
  - Throws user-friendly error if model path not found (`generic.pathNotFound`)
  - Imports `buildWSTGListPrompt` from `wstg-selection-prompt.ts` (extracted for testability)

- **`apps/electron/src/renderer/pages/TestCaseGeneratorPage.tsx`**
  - Added error state and UI error display: surfaces LMStudio errors to user instead of silently returning 0 results

- **`apps/electron/src/main/wstg-selection-prompt.ts`** *(new)*
  - Extracted from `lmstudio.ts` — no electron dependencies, testable in bun
  - `buildWSTGListPrompt(attackVector)`: builds first-pass selection prompt using thin content (titles only, not descriptions)
  - Reads from `wstg-thin-content.json`

- **`apps/electron/scripts/build-wstg-thin-json.ts`** *(new)*
  - Build-time script: reads `wstg-tests-thin/` → outputs `src/main/wstg-thin-content.json`
  - 108 entries, ~45KB (vs 826KB full content)

- **`apps/electron/package.json`**
  - `build:wstg` now runs both: `bun scripts/build-wstg-json.ts && bun scripts/build-wstg-thin-json.ts`

- **`apps/electron/src/main/__tests__/lmstudio.test.ts`**
  - Added `beforeAll(() => setBundledAssetsRoot(...))` to fix 16 pre-existing prompt-loader failures
  - Added `buildWSTGListPrompt` test suite (4 tests): verifies attack vector, IDs, uses titles not descriptions, excludes full markdown
  - Added `wstg-thin-content.json` integrity suite (4 tests): 108 entries, key format, non-empty, matches WSTG_ENTRIES
  - **42/43 pass** (1 pre-existing failure: truncation TODO in `buildAugmentedPrompt`)

**Decisions:**
- **Two-pass architecture**: thin content (45KB) for first-pass WSTG selection prompt; full content (826KB) for second-pass augmented generation. Thin files live in `wstg-tests-thin/`.
- **No model unload after use**: LMStudio is a persistent server; unloading after each request would cause unnecessary reload latency. TTL management is the user's responsibility via LMStudio settings.
- **Extracted `buildWSTGListPrompt`**: avoids transitive `electron` import when running bun tests.

**Status:**
- ✅ Auto-load logic implemented
- ✅ UI error surfacing implemented
- ✅ Thin content two-pass architecture implemented
- ✅ Tests added and passing (42/43)
- ⏳ End-to-end verification pending (unload model in LMStudio, confirm auto-load + thin prompt fits context)
- ⏳ Commit & PR not yet created
